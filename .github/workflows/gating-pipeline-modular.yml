name: CI/CD Security Gating Pipeline (Modular)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      override_gates:
        description: 'Override security gates (requires approval)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      user_role:
        description: 'User role for testing (configure in Permit.io)'
        required: false
        default: 'ci-pipeline'
        type: choice
        options:
          - 'ci-pipeline'
          - 'developer'
          - 'editor'
          - 'security-admin'

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.8.6'
  DOCKER_BUILDKIT: 1
  PDP_URL: http://localhost:7766

jobs:
  build:
    name: Build Application
    uses: ./.github/workflows/build-application.yml
    with:
      java-version: '17'
      maven-version: '3.8.6'
          
  security-scan:
    name: Security Scan
    needs: build
    uses: ./.github/workflows/security-scanning.yml
    with:
      java-version: '17'
      run-container-scan: ${{ github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' }}
    secrets:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}

  code-quality:
    name: Code Quality Analysis
    needs: build
    uses: ./.github/workflows/quality-analysis.yml
    with:
      java-version: '17'
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          
  security-gates:
    name: Security Gate Evaluation
    runs-on: ubuntu-latest
    needs: [security-scan, code-quality]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download security results
        uses: actions/download-artifact@v4
        with:
          name: security-results
          path: .
          
      - name: Download quality results
        uses: actions/download-artifact@v4
        with:
          name: quality-results
          path: .
        continue-on-error: true
          
      - name: Recreate expected directory structure
        run: |
          echo "ðŸ“ Recreating directory structure for security results..."
          mkdir -p snyk-scanning/results
          
          # Move Snyk results files to expected locations (if they exist)
          mv snyk-results.json snyk-scanning/results/ 2>/dev/null || echo "snyk-results.json not found"
          mv snyk-code-results.json snyk-scanning/results/ 2>/dev/null || echo "snyk-code-results.json not found"  
          mv snyk-container-results.json snyk-scanning/results/ 2>/dev/null || echo "snyk-container-results.json not found"
          
          echo "ðŸ“Š Verifying Snyk results file locations:"
          ls -la snyk-scanning/results/ || echo "âš ï¸ snyk-scanning/results directory not found"
          
      - name: Install jq for JSON parsing
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          
      - name: Validate Permit.io configuration
        env:
          PERMIT_API_KEY: ${{ secrets.PERMIT_API_KEY }}
        run: |
          chmod +x permit-gating/scripts/validate-permit.sh
          ./permit-gating/scripts/validate-permit.sh

      - name: Start Docker Compose services
        env:
          PERMIT_API_KEY: ${{ secrets.PERMIT_API_KEY }}
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}
          USER_KEY: ${{ github.actor }}
          USER_ROLE: ${{ github.event.inputs.user_role || 'editor' }}
        run: |
          # Create .env file only for Docker Compose (required by docker-compose.yml)
          cat > .env << EOF
          PERMIT_API_KEY=$PERMIT_API_KEY
          SNYK_TOKEN=$SNYK_TOKEN
          SNYK_ORG_ID=$SNYK_ORG_ID
          USER_KEY=${USER_KEY}
          USER_ROLE=${USER_ROLE}
          EOF
          
          # Start Docker Compose services
          docker compose up -d --build
          
          # Wait for services to be ready with better health checks
          echo "Waiting for services to start..."
          sleep 30
          
          # Check service health using multiple endpoints
          echo "Checking service health..."
          
          # Check PDP health on correct port
          for i in {1..10}; do
            if curl -sf http://localhost:7001/healthy > /dev/null 2>&1; then
              echo "âœ“ PDP health endpoint is responding"
              break
            elif [ $i -eq 10 ]; then
              echo "âœ— PDP failed to become ready"
              docker compose logs permit-pdp
              exit 1
            else
              echo "Attempt $i/10: PDP not ready yet..."
              sleep 3
            fi
          done
          
          # Verify PDP is fully synced with Permit.io cloud
          echo "Verifying PDP sync with Permit.io cloud..."
          for i in {1..20}; do
            response=$(curl -s -X POST http://localhost:7766/allowed \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $PERMIT_API_KEY" \
              -d '{"user":{"key":"david-santander","attributes":{"role":"editor"}},"action":"test","resource":{"type":"deployment","key":"sync-test","attributes":{}}}' 2>/dev/null || echo "{}")
            
            if echo "$response" | grep -q '"synced":true'; then
              echo "âœ“ PDP is fully synced with Permit.io cloud"
              break
            elif [ $i -eq 20 ]; then
              echo "âš ï¸ PDP sync verification timeout - proceeding anyway"
            else
              echo "  Waiting for PDP to sync with cloud... ($i/20)"
              sleep 3
            fi
          done
          
      - name: Debug User Context
        run: |
          echo "ðŸ” GitHub Context Debug:"
          echo "  GitHub Actor: ${{ github.actor }}"
          echo "  User Role Input: ${{ github.event.inputs.user_role }}"
          
      - name: Evaluate Security Gates
        id: gate_evaluation
        env:
          PDP_URL: ${{ env.PDP_URL }}
          PERMIT_API_KEY: ${{ secrets.PERMIT_API_KEY }}
          USER_KEY: ${{ github.actor }}
          USER_ROLE: ${{ github.event.inputs.user_role || 'editor' }}
        run: |
          echo "ðŸ” Evaluating security gates:"
          echo "  Permit.io User Key: ${USER_KEY}"
          echo "  Permit.io User Role: ${USER_ROLE}"
          echo "  GitHub Actor: ${{ github.actor }}"
          echo ""
          
          # Initialize gate results
          SECURITY_GATE_RESULT=0
          QUALITY_GATE_RESULT=0
          
          # Run security vulnerability gate evaluation
          echo "Evaluating security vulnerability gates..."
          chmod +x permit-gating/scripts/evaluate-gates.sh
          
          # Disable exit on error temporarily to capture exit code
          set +e
          ./permit-gating/scripts/evaluate-gates.sh snyk-scanning/results/snyk-results.json
          SECURITY_GATE_RESULT=$?
          set -e
          
          # Check SonarQube quality gate if configured
          if [ -f "sonarqube-cloud-scanning/results/quality-gate-result.json" ]; then
            echo ""
            echo "Evaluating code quality gates..."
            
            QG_DECISION=$(jq -r '.quality_gate.decision // "UNKNOWN"' sonarqube-cloud-scanning/results/quality-gate-result.json)
            QG_REASON=$(jq -r '.quality_gate.reason // "No reason provided"' sonarqube-cloud-scanning/results/quality-gate-result.json)
            QG_EXIT_CODE=$(jq -r '.gate_result.exit_code // 0' sonarqube-cloud-scanning/results/quality-gate-result.json)
            
            case "$QG_EXIT_CODE" in
              0)
                echo "âœ… Code quality gate: PASSED - $QG_REASON"
                QUALITY_GATE_RESULT=0
                ;;
              1)
                echo "âš ï¸ Code quality gate: WARNING - $QG_REASON"
                QUALITY_GATE_RESULT=1
                ;;
              2)
                echo "âŒ Code quality gate: FAILED - $QG_REASON"
                QUALITY_GATE_RESULT=2
                ;;
              *)
                echo "â“ Code quality gate: UNKNOWN - $QG_REASON"
                QUALITY_GATE_RESULT=0
                ;;
            esac
          else
            echo "â„¹ï¸ SonarQube quality gate not evaluated (not configured or results not available)"
            QUALITY_GATE_RESULT=0
          fi
          
          # Combine gate results (take the worst result)
          if [ $SECURITY_GATE_RESULT -eq 2 ] || [ $QUALITY_GATE_RESULT -eq 2 ]; then
            GATE_RESULT=2  # FAIL
            echo ""
            echo "ðŸš« Combined gate decision: BLOCKED"
          elif [ $SECURITY_GATE_RESULT -eq 1 ] || [ $QUALITY_GATE_RESULT -eq 1 ]; then
            GATE_RESULT=1  # WARNING
            echo ""
            echo "âš ï¸ Combined gate decision: WARNING"
          else
            GATE_RESULT=0  # PASS
            echo ""
            echo "âœ… Combined gate decision: PASSED"
          fi
          
          echo "GATE_RESULT=$GATE_RESULT" >> $GITHUB_OUTPUT
          echo "SECURITY_GATE_RESULT=$SECURITY_GATE_RESULT" >> $GITHUB_OUTPUT
          echo "QUALITY_GATE_RESULT=$QUALITY_GATE_RESULT" >> $GITHUB_OUTPUT
          
          # Enhanced summary generation
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸšª Security Gate Evaluation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ” Authorization Context" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ User | ${USER_KEY} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ­ Role | ${USER_ROLE} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ Policy Engine | Permit.io PDP |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Set job status based on gate result
          case $GATE_RESULT in
            0)
              echo "### âœ… Gate Decision: **PASSED**" >> $GITHUB_STEP_SUMMARY
              echo "ðŸŽ‰ **Result:** All security requirements met. Deployment authorized." >> $GITHUB_STEP_SUMMARY
              exit 0
              ;;
            1)
              echo "### âš ï¸ Gate Decision: **WARNING**" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ“‹ **Result:** Non-blocking issues detected. Proceeding with caution." >> $GITHUB_STEP_SUMMARY
              exit 0
              ;;
            2)
              echo "### âŒ Gate Decision: **BLOCKED**" >> $GITHUB_STEP_SUMMARY
              echo "ðŸ›‘ **Result:** Security requirements not met. Deployment blocked by policy." >> $GITHUB_STEP_SUMMARY
              
              if [ "${{ github.event.inputs.override_gates }}" != "true" ]; then
                exit 2
              else
                echo "âš ï¸ **OVERRIDE ACTIVATED** - Gates bypassed by authorized user" >> $GITHUB_STEP_SUMMARY
                exit 0
              fi
              ;;
            *)
              echo "### â“ Gate Decision: **ERROR**" >> $GITHUB_STEP_SUMMARY
              exit 2
              ;;
          esac
          
      - name: Stop Docker Compose services
        if: always()
        run: |
          docker compose down
          
  build-docker-image:
    name: Build Docker Image
    needs: security-gates
    if: success() || (github.event.inputs.override_gates == 'true')
    uses: ./.github/workflows/docker-build.yml
    with:
      image-tag: ${{ github.sha }}
      load-prebuilt-image: ${{ github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch' }}
          
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    needs: build-docker-image
    if: github.ref == 'refs/heads/main' && (success() || github.event.inputs.override_gates == 'true')
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          
      - name: Load Docker image
        run: |
          docker load < gating-poc-app.tar
          
      - name: Deploy to environment
        run: |
          echo "ðŸš€ Deploying application version ${{ github.sha }}"
          
          # Capture deployment start time
          DEPLOY_START=$(date +%s)
          
          # Add actual deployment steps here
          # For PoC, we'll just run the container locally
          docker run -d -p 8080:8080 --name gating-poc-app gating-poc-app:${{ github.sha }}
          
          # Wait for application to start
          sleep 10
          
          # Health check
          HEALTH_STATUS="Unknown"
          if curl -f http://localhost:8080/actuator/health 2>/dev/null; then
            HEALTH_STATUS="Healthy"
            HEALTH_ICON="âœ…"
          else
            HEALTH_STATUS="Unhealthy"
            HEALTH_ICON="âŒ"
            exit 1
          fi
          
          # Calculate deployment time
          DEPLOY_END=$(date +%s)
          DEPLOY_TIME=$((DEPLOY_END - DEPLOY_START))
          
          # Enhanced deployment summary
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ Status | **âœ… SUCCESS** |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ Version | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Environment | Production |" >> $GITHUB_STEP_SUMMARY
          echo "| â±ï¸ Deploy Time | ${DEPLOY_TIME}s |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ’š Health Check | ${HEALTH_ICON} ${HEALTH_STATUS} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”€ Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ Deployed By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“… Timestamp | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.override_gates }}" = "true" ]; then
            echo "âš ï¸ **Note:** Security gates were overridden for this deployment." >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: Cleanup
        if: always()
        run: |
          docker stop gating-poc-app || true
          docker rm gating-poc-app || true